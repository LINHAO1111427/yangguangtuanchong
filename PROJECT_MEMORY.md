# é¡¹ç›®æ€»è§ˆ - å°ç»¿æ ‘å¾®æœåŠ¡æ¶æ„

## ğŸ”´ å¼ºåˆ¶æ¶æ„è§„åˆ™ï¼ˆæ‰€æœ‰å¼€å‘è€…å¿…é¡»éµå®ˆï¼‰

### æ•°æ®åº“éš”ç¦»åŸåˆ™
1. **ç¦æ­¢è·¨åº“JOINæŸ¥è¯¢** - å‘ç°å³é‡æ„ï¼Œæ— ä¾‹å¤–
2. **ç¦æ­¢ä¸šåŠ¡æ¨¡å—ç›´è¿å…¶ä»–æ¨¡å—æ•°æ®åº“** - å¿…é¡»é€šè¿‡Feign API
3. **Bç«¯ä¸Cç«¯æ•°æ®ç‰©ç†éš”ç¦»** - systemåº“(Bç«¯ç®¡ç†)ä¸memberåº“(Cç«¯ç”¨æˆ·)åˆ†ç¦»
4. **æ ¸å¿ƒä¸šåŠ¡æ•°æ®å¿…é¡»ç‹¬ç«‹** - contentæ–‡ä»¶å­˜å‚¨å¿…é¡»è„±ç¦»infra

### å¾®æœåŠ¡é€šä¿¡è§„åˆ™
1. **ä¾èµ–å±‚çº§**ï¼š
   - **ç¦æ­¢å¼ºä¾èµ–**ï¼šmemberæ ¸å¿ƒåŠŸèƒ½ï¼ˆæ³¨å†Œã€ç™»å½•ã€ç­‰çº§ã€ç§¯åˆ†ï¼‰ä¸å¾—ä¾èµ–å…¶ä»–ä¸šåŠ¡æ¨¡å—
   - **å…è®¸å¼±ä¾èµ–**ï¼šmemberçš„å±•ç¤ºæ¥å£å¯é€šè¿‡Feignè°ƒç”¨å…¶ä»–æ¨¡å—åšæ•°æ®èšåˆï¼Œä½†å¿…é¡»åšé™çº§å¤„ç†ï¼ˆtry-catch + é»˜è®¤å€¼ï¼‰
   - **å•å‘è°ƒç”¨**ï¼šcontent/message/mall/pay â†’ åªå…è®¸ä¾èµ–member
2. **RPCè°ƒç”¨å¿…é¡»é€šè¿‡Domain Serviceå°è£…** - ç¦æ­¢Controllerç›´æ¥è°ƒç”¨FeignClient
3. **æ•°æ®å†—ä½™ä¼˜äºè·¨åº“æŸ¥è¯¢** - å…³é”®å­—æ®µå¿…é¡»å†—ä½™å­˜å‚¨

**å¼ºä¾èµ– vs å¼±ä¾èµ–ç¤ºä¾‹**ï¼š
```java
// âŒ å¼ºä¾èµ–ï¼ˆç¦æ­¢ï¼‰ï¼šæ ¸å¿ƒåŠŸèƒ½ä¾èµ–å…¶ä»–æ¨¡å—
public void registerUser(UserRegisterReq req) {
    contentApi.initUserSpace(userId);  // memberæ³¨å†Œä¾èµ–content â†’ ç¦æ­¢
}

// âœ… å¼±ä¾èµ–ï¼ˆå…è®¸ï¼‰ï¼šå±•ç¤ºæ¥å£èšåˆæ•°æ®ï¼Œæœ‰é™çº§
public UserProfileResp getUserProfile(Long userId) {
    try {
        stats = contentApi.getUserStats(userId);  // èšåˆå±•ç¤ºæ•°æ®
    } catch (Exception ex) {
        stats = defaultStats();  // â† é™çº§å¤„ç†ï¼ŒcontentæŒ‚äº†ä¸å½±å“member
    }
}
```

### ç´§æ€¥è§„èŒƒ
- å•æ¬¡PRä¸å¾—è¶…è¿‡5ä¸ªæ–‡ä»¶æ”¹åŠ¨
- æ–°å»ºè¡¨å¿…é¡»åŒ…å«create_timeç´¢å¼•
- æ‰€æœ‰æ¥å£å¿…é¡»æ·»åŠ Swaggeræ–‡æ¡£
- MyBatis XMLä¸­ç¦æ­¢å‡ºç°${}ï¼Œå¿…é¡»ä½¿ç”¨#{}

---

## ğŸ“‹ é¡¹ç›®æ¶æ„æ€»è§ˆ

### æŠ€æœ¯æ ˆ
- **åç«¯æ¡†æ¶**ï¼šSpring Cloud Alibaba 2023.0.1 + Spring Boot 3.2
- **æ•°æ®åº“**ï¼šPostgreSQL 15 + MySQL 8.0ï¼ˆéƒ¨åˆ†å…¼å®¹ï¼‰
- **ç¼“å­˜**ï¼šRedis 6.0 + Redisson
- **æ¶ˆæ¯é˜Ÿåˆ—**ï¼šKafka 2.8 + RocketMQ 5.0
- **æ³¨å†Œä¸­å¿ƒ**ï¼šNacos 2.3
- **æ–‡ä»¶å­˜å‚¨**ï¼šMinIO + é˜¿é‡Œäº‘OSS

### ä¸šåŠ¡æ¨¡å—çŸ©é˜µ

| æ¨¡å— | æ•°æ®åº“ | ç«¯å£ | ä¾èµ–å…³ç³» | çŠ¶æ€ |
|------|--------|------|----------|------|
| **infra-server** | xiaolvshu_base | 48082 | æ— ä¾èµ– | âœ… è¿è¡Œä¸­ |
| **system-server** | xiaolvshu_base | 48081 | ä¾èµ–infra | âœ… è¿è¡Œä¸­ |
| **member-server** | ruoyi-vue-proï¼ˆå…±äº«system_usersï¼‰ | 48087 | æ ¸å¿ƒæ— ä¾èµ–ï¼›å±•ç¤ºæ¥å£å¼±ä¾èµ–content | âœ… å·²æ„å»º |
| **content-server** | xiaolvshu_content | 48083 | ä¾èµ–infraï¼ˆæ–‡ä»¶å­˜å‚¨ï¼‰ã€member | âš ï¸ éœ€æ”¹é€  |
| **message-server** | xiaolvshu_message | 48084 | ä¾èµ–infraã€member | âš ï¸ éœ€éªŒè¯ |
| **mall-server** | xiaolvshu_mall | 48086 | ä¾èµ–member | âš ï¸ è§„åˆ’ä¸­ |
| **pay-server** | xiaolvshu_pay | 48087 | ä¾èµ–member | âš ï¸ è§„åˆ’ä¸­ |

---

## ğŸ¯ å½“å‰æ¶æ„é—®é¢˜æ¸…å•

### ä¸¥é‡é—®é¢˜ï¼ˆå¿…é¡»ç«‹å³è§£å†³ï¼‰

#### 1. Contentæ–‡ä»¶å­˜å‚¨è€¦åˆInfraï¼ˆP0ï¼‰
- **ç°çŠ¶**ï¼šè§†é¢‘/å›¾ç‰‡å…ƒæ•°æ®å­˜å‚¨åœ¨`infra_file`è¡¨ï¼ˆbaseåº“ï¼‰
- **é£é™©**ï¼š
  - Contentæ— æ³•ç‹¬ç«‹å¤‡ä»½/è¿ç§»/å½’æ¡£
  - Infraè¡¨æˆä¸ºæ€§èƒ½ç“¶é¢ˆ
  - æ–‡ä»¶ç”Ÿå‘½å‘¨æœŸç®¡ç†è·¨æ¨¡å—
- **è§£å†³æ–¹æ¡ˆ**ï¼šåˆ›å»º`content_file`è¡¨ï¼Œè¿ç§»æ–‡ä»¶å…ƒæ•°æ®
- **è´Ÿè´£äºº**ï¼šæŠ€æœ¯è´Ÿè´£äºº
- **æˆªæ­¢æ—¥æœŸ**ï¼š2025-11-30

#### 2. ç”¨æˆ·æ¨¡å—æ¶æ„å†³ç­–ï¼ˆå·²è§£å†³ âœ…ï¼‰
- **å†³ç­–**ï¼šé‡‡ç”¨"å…±äº«ç”¨æˆ·ä¸»è¡¨"æ–¹æ¡ˆï¼ˆADR-001ï¼‰
  - Cç«¯å’ŒBç«¯ç”¨æˆ·å…±äº« `system_users` è¡¨ï¼ˆruoyi-vue-proåº“ï¼‰
  - é€šè¿‡ `user_type` å­—æ®µåŒºåˆ†ï¼š0=ç®¡ç†å‘˜, 1=Cç«¯ç”¨æˆ·
  - Cç«¯æ‰©å±•ä¿¡æ¯å­˜å‚¨åœ¨ `member_profile` è¡¨
- **ç†ç”±**ï¼š
  - âœ… è®¤è¯ç³»ç»Ÿç»Ÿä¸€ - ä¸€ä¸ªç™»å½•å…¥å£ï¼ŒJWT Tokenç»Ÿä¸€ç­¾å‘
  - âœ… æ— è·¨åº“æŸ¥è¯¢ - content/messageæ¨¡å—æŸ¥ç”¨æˆ·ä¿¡æ¯åŒåº“JOIN
  - âœ… äº‹åŠ¡ä¸€è‡´æ€§ - ç”¨æˆ·æ³¨å†Œæ¶‰åŠsystem+memberï¼ŒåŒåº“äº‹åŠ¡ä¿è¯
- **çŠ¶æ€**ï¼šmember-serverå·²æ„å»ºå®Œæˆï¼Œä½¿ç”¨ruoyi-vue-proæ•°æ®åº“

### ä¸€èˆ¬é—®é¢˜ï¼ˆè®¡åˆ’å†…è§£å†³ï¼‰

#### 3. æ•°æ®åº“è¿æ¥é…ç½®æ··ä¹±
- **ç°çŠ¶**ï¼šå„æ¨¡å—ä½¿ç”¨ä¸åŒæ•°æ®åº“å®ä¾‹ï¼ˆ55432/55433ç­‰ï¼‰
- **å»ºè®®**ï¼šç»Ÿä¸€ä½¿ç”¨55432ç«¯å£ï¼Œé€šè¿‡database nameåŒºåˆ†

#### 4. ç¼ºå°‘ç»Ÿä¸€çš„æ•°æ®å½’æ¡£ç­–ç•¥
- **é£é™©**ï¼šPGåˆ†åŒºè¡¨å·²åˆ›å»ºï¼Œä½†å½’æ¡£è„šæœ¬æœªå®ç°
- **å»ºè®®**ï¼šå®ç°è‡ªåŠ¨å½’æ¡£åˆ°MinIO/S3å†·å­˜å‚¨

---

## ğŸ—‚ï¸ æ•°æ®åº“æ¶æ„è®¾è®¡

### æ•°æ®åº“åˆ†å±‚æ¨¡å‹

```
xiaolvshu_base (Bç«¯ç®¡ç†æ•°æ®åº“)
â”œâ”€â”€ infra_*          # åŸºç¡€è®¾æ–½è¡¨ï¼ˆä»£ç ç”Ÿæˆã€æ–‡ä»¶é…ç½®ç­‰ï¼‰
â”œâ”€â”€ system_*         # ç³»ç»Ÿç®¡ç†è¡¨ï¼ˆéƒ¨é—¨ã€å²—ä½ã€è§’è‰²ç­‰ï¼‰
â””â”€â”€ bpm_*           # å·¥ä½œæµè¡¨

xiaolvshu_member (Cç«¯ç”¨æˆ·ä¸­å¿ƒ)
â”œâ”€â”€ member_users     # Cç«¯ç”¨æˆ·ä¸»è¡¨
â”œâ”€â”€ member_level     # ä¼šå‘˜ç­‰çº§
â”œâ”€â”€ member_points    # ç§¯åˆ†æµæ°´
â””â”€â”€ member_auth_*    # ä¸‰æ–¹æˆæƒç™»å½•

xiaolvshu_content (å†…å®¹æ ¸å¿ƒä¸šåŠ¡)
â”œâ”€â”€ content_post     # å†…å®¹ä¸»è¡¨ï¼ˆå·²åˆ†åŒºï¼‰
â”œâ”€â”€ content_media    # åª’ä½“èµ„æºè¡¨
â”œâ”€â”€ content_comment  # è¯„è®ºè¡¨
â”œâ”€â”€ content_topic    # è¯é¢˜è¡¨
â””â”€â”€ content_file     # æ–‡ä»¶å…ƒæ•°æ®ï¼ˆå¾…åˆ›å»ºï¼‰

xiaolvshu_message (æ¶ˆæ¯ç³»ç»Ÿ)
â”œâ”€â”€ message_thread   # ä¼šè¯è¡¨
â”œâ”€â”€ message_participant # ä¼šè¯å‚ä¸è€…
â””â”€â”€ message_record   # æ¶ˆæ¯è®°å½•è¡¨

xiaolvshu_mall (ç”µå•†ç³»ç»Ÿ)
â”œâ”€â”€ product_*        # å•†å“ç›¸å…³
â”œâ”€â”€ order_*          # è®¢å•ç›¸å…³
â””â”€â”€ cart_*           # è´­ç‰©è½¦

xiaolvshu_pay (æ”¯ä»˜ç³»ç»Ÿ)
â”œâ”€â”€ pay_order        # æ”¯ä»˜è®¢å•
â””â”€â”€ pay_refund       # é€€æ¬¾è®°å½•
```

### æ•°æ®åº“è®¿é—®çŸ©é˜µ

| è°ƒç”¨æ–¹ \ æ•°æ®æ–¹ | infra | system | member | content | message | mall | pay |
|----------------|-------|--------|--------|---------|---------|------|-----|
| **infra**      | âœ…    | âŒ     | âŒ     | âŒ      | âŒ      | âŒ   | âŒ  |
| **system**     | âœ…    | âœ…     | âŒ     | âŒ      | âŒ      | âŒ   | âŒ  |
| **member**     | âœ…    | âŒ     | âœ…     | âŒ      | âŒ      | âŒ   | âŒ  |
| **content**    | âš ï¸    | âŒ     | âœ…     | âœ…      | âŒ      | âŒ   | âŒ  |
| **message**    | âœ…    | âŒ     | âœ…     | âŒ      | âœ…      | âŒ   | âŒ  |
| **mall**       | âœ…    | âŒ     | âœ…     | âŒ      | âŒ      | âœ…   | âŒ  |
| **pay**        | âœ…    | âŒ     | âœ…     | âŒ      | âŒ      | âŒ   | âœ…  |

âœ… = å…è®¸è®¿é—®  âŒ = ç¦æ­¢è®¿é—®  âš ï¸ = å¾…æ”¹é€ 

---

## ğŸ“ å¾®æœåŠ¡é—´è°ƒç”¨è§„èŒƒ

### å…è®¸çš„è°ƒç”¨é“¾

```
content-server
    â”œâ”€â”€> infra-server (æ”¹é€ åä»…è°ƒç”¨é…ç½®)
    â””â”€â”€> member-server (æŸ¥è¯¢ç”¨æˆ·è¯¦æƒ…)

message-server
    â”œâ”€â”€> infra-server
    â””â”€â”€> member-server (æŸ¥è¯¢ç”¨æˆ·è¯¦æƒ…)

mall-server
    â”œâ”€â”€> infra-server
    â”œâ”€â”€> member-server (æŸ¥è¯¢ç”¨æˆ·è¯¦æƒ…)
    â””â”€â”€> pay-server (åˆ›å»ºæ”¯ä»˜è®¢å•)

pay-server
    â”œâ”€â”€> infra-server
    â””â”€â”€> member-server (æŸ¥è¯¢ç”¨æˆ·è¯¦æƒ…)

infra-server & system-server
    â””â”€â”€> ä¸è°ƒç”¨ä»»ä½•ä¸šåŠ¡æ¨¡å—ï¼Œä¿æŒåº•å±‚çº¯å‡€
```

### ç¦æ­¢çš„åæ¨¡å¼

```java
// âŒ ç¦æ­¢ï¼šControllerç›´æ¥è°ƒç”¨FeignClient
@RestController
public class ContentController {
    @Resource
    private FileApi fileApi;  // è·¨æ¨¡å—è°ƒç”¨åœ¨Controllerå±‚

    @PostMapping("/upload")
    public Result upload() {
        fileApi.createFile(...);  // âŒ åº”è¯¥åœ¨Serviceå±‚å°è£…
    }
}

// âœ… æ­£ç¡®ï¼šé€šè¿‡Domain Serviceå°è£…
@Service
public class ContentMediaService {
    @Resource
    private FileApi fileApi;

    public String uploadVideo(...) {
        // ä¸šåŠ¡é€»è¾‘æ ¡éªŒ
        validateVideo(file);
        // è°ƒç”¨ä¸‹æ¸¸
        return fileApi.createFile(...);
    }
}
```

---

## ğŸ”„ å®æ–½è·¯çº¿å›¾

### Phase 1: åŸºç¡€è®¾æ–½å‡†å¤‡ï¼ˆWeek 1-2ï¼‰
- [ ] åˆ›å»ºæ‰€æœ‰ä¸šåŠ¡æ•°æ®åº“
- [ ] æ„å»ºmember-serveræ¨¡å—
- [ ] æ•°æ®åº“æƒé™é…ç½®ä¸è¿æ¥æ± ä¼˜åŒ–
- [ ] å¼€å‘ç¯å¢ƒè”è°ƒ

### Phase 2: æ ¸å¿ƒä¸šåŠ¡æ”¹é€ ï¼ˆWeek 3-5ï¼‰
- [ ] Contentæ¨¡å—æ–‡ä»¶å­˜å‚¨ç‹¬ç«‹åŒ–ï¼ˆP0ï¼‰
- [ ] Contentæ¨¡å—æ¥å…¥memberæœåŠ¡
- [ ] Messageæ¨¡å—æ¥å…¥memberæœåŠ¡
- [ ] æ•°æ®è¿ç§»ä¸åŒå†™éªŒè¯

### Phase 3: ä¸šåŠ¡å®Œæ•´ç‹¬ç«‹ï¼ˆWeek 6-8ï¼‰
- [ ] Mallæ¨¡å—ç‹¬ç«‹æ•°æ®åº“
- [ ] Payæ¨¡å—ç‹¬ç«‹æ•°æ®åº“
- [ ] æ”¯ä»˜å›è°ƒä¸è®¢å•çŠ¶æ€åŒæ­¥ä¼˜åŒ–
- [ ] æ€§èƒ½å‹æµ‹ä¸ç›‘æ§å®Œå–„

### Phase 4: è¿ç»´ä¸ç›‘æ§ï¼ˆWeek 9-10ï¼‰
- [ ] å®Œå–„SkyWalkingé“¾è·¯è¿½è¸ª
- [ ] é…ç½®Grafanaç›‘æ§å¤§ç›˜
- [ ] æ•°æ®åº“æ…¢æŸ¥è¯¢ä¼˜åŒ–
- [ ] å¼‚åœ°å¤‡ä»½ç­–ç•¥å®æ–½

---

## ğŸ“ å…³é”®è”ç³»äºº

| è§’è‰² | å§“å | è´Ÿè´£æ¨¡å— | è”ç³»æ–¹å¼ |
|------|------|----------|----------|
| æ¶æ„è´Ÿè´£äºº | - | æ•´ä½“æ¶æ„è®¾è®¡ | - |
| åç«¯è´Ÿè´£äºº | - | å¾®æœåŠ¡æ”¹é€  | - |
| DBA | - | æ•°æ®åº“ä¼˜åŒ– | - |
| æµ‹è¯•è´Ÿè´£äºº | - | é›†æˆæµ‹è¯• | - |

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [å¾®æœåŠ¡æ”¹é€ è¯¦ç»†æ–¹æ¡ˆ](./docs/architecture/microservice-refactor.md)
- [æ•°æ®åº“è®¾è®¡æ–‡æ¡£](./docs/database/schema-design.md)
- [APIæ¥å£è§„èŒƒ](./docs/api/rest-api-standard.md)
- [ä¸Šçº¿æ£€æŸ¥æ¸…å•](./docs/deployment/checklist.md)

---

**æœ€åæ›´æ–°**ï¼š2025-11-12
**ç‰ˆæœ¬**ï¼šv1.0
**çŠ¶æ€**ï¼šæ¶æ„è®¾è®¡ä¸­
